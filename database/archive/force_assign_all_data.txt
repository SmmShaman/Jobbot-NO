
-- ULTIMATE FIX SCRIPT (RADICAL TAKEOVER)
-- Ð¦ÐµÐ¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¾Ð²Ð°Ð½Ð¾ Ñ€Ð¾Ð±Ð¸Ñ‚ÑŒ Ð²Ð°Ñ ÐÐ´Ð¼Ñ–Ð½Ð¾Ð¼ Ñ– Ð²Ð»Ð°ÑÐ½Ð¸ÐºÐ¾Ð¼ Ð’Ð¡Ð†Ð¥ Ð´Ð°Ð½Ð¸Ñ… Ð² Ð±Ð°Ð·Ñ–.

DO $$
DECLARE
    target_email TEXT := 'smmshaman@gmail.com'; -- Ð’ÐÐ¨ EMAIL
    target_user_id UUID;
    count_jobs INTEGER;
    count_profiles INTEGER;
    count_apps INTEGER;
    count_kb INTEGER;
BEGIN
    -- 1. Ð—Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ID ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
    SELECT id INTO target_user_id FROM auth.users WHERE email = target_email;

    IF target_user_id IS NULL THEN
        RAISE EXCEPTION 'ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° % Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾! Ð¡Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð·Ð°Ñ€ÐµÑ”ÑÑ‚Ñ€ÑƒÐ¹Ñ‚ÐµÑÑŒ.', target_email;
    END IF;

    RAISE NOTICE 'Found User ID: %', target_user_id;

    -- 2. ÐŸÐ Ð˜ÐœÐ£Ð¡ÐžÐ’Ð• ÐÐ”ÐœÐ†ÐÐ¡Ð¢Ð’Ðž
    -- Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ñ– ÐºÐ¾Ð½Ñ„Ð»Ñ–ÐºÑ‚Ð½Ñ– Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ, ÑÐºÑ‰Ð¾ Ð²Ð¾Ð½Ð¸ Ð¿Ð¾ÑˆÐºÐ¾Ð´Ð¶ÐµÐ½Ñ–
    -- DELETE FROM public.user_settings WHERE user_id = target_user_id; 
    -- (ÐšÑ€Ð°Ñ‰Ðµ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ñ”Ð¼Ð¾ UPSERT, Ñ‰Ð¾Ð± Ð·Ð±ÐµÑ€ÐµÐ³Ñ‚Ð¸ Ñ–ÑÐ½ÑƒÑŽÑ‡Ñ– Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ ÑÐºÑ‰Ð¾ Ð²Ð¾Ð½Ð¸ Ñ”, Ð°Ð»Ðµ Ð·Ð¼Ñ–Ð½Ð¸Ñ‚Ð¸ Ñ€Ð¾Ð»ÑŒ)

    INSERT INTO public.user_settings (user_id, role, ui_language, is_auto_scan_enabled)
    VALUES (target_user_id, 'admin', 'uk', false)
    ON CONFLICT (user_id) 
    DO UPDATE SET role = 'admin';

    RAISE NOTICE 'âœ… Settings updated: User is now ADMIN.';

    -- 3. ÐŸÐ Ð˜Ð’Ð›ÐÐ¡ÐÐ•ÐÐÐ¯ Ð’Ð¡Ð†Ð¥ Ð”ÐÐÐ˜Ð¥ (Takeover)
    -- ÐœÐ¸ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾, Ñ‡Ð¸Ñ— Ð²Ð¾Ð½Ð¸ Ð±ÑƒÐ»Ð¸ Ñ€Ð°Ð½Ñ–ÑˆÐµ. ÐœÐ¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð·Ð°Ð±Ð¸Ñ€Ð°Ñ”Ð¼Ð¾ Ð²ÑÐµ.
    
    -- Jobs
    UPDATE public.jobs 
    SET user_id = target_user_id;
    GET DIAGNOSTICS count_jobs = ROW_COUNT;
    
    -- Profiles
    UPDATE public.cv_profiles 
    SET user_id = target_user_id;
    GET DIAGNOSTICS count_profiles = ROW_COUNT;

    -- Applications
    UPDATE public.applications 
    SET user_id = target_user_id;
    GET DIAGNOSTICS count_apps = ROW_COUNT;

    -- Knowledge Base
    UPDATE public.user_knowledge_base 
    SET user_id = target_user_id;
    GET DIAGNOSTICS count_kb = ROW_COUNT;

    -- System Logs (Optional, usually logs are global but we can tag them)
    -- UPDATE public.system_logs SET ... (Skipping logs to keep history intact)

    RAISE NOTICE 'ðŸŽ‰ TAKEOVER COMPLETE!';
    RAISE NOTICE '   - Jobs: %', count_jobs;
    RAISE NOTICE '   - Profiles: %', count_profiles;
    RAISE NOTICE '   - Applications: %', count_apps;
    RAISE NOTICE '   - KB Items: %', count_kb;
    RAISE NOTICE 'âš ï¸ IMPORTANT: Now Go to Sidebar -> Click "Log Out" -> Log In again to see changes!';

END $$;
