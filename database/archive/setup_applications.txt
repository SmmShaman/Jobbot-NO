-- 1. Створюємо таблицю 'applications' (Заявки)
create table if not exists public.applications (
  id uuid default gen_random_uuid() primary key,
  job_id uuid references public.jobs(id) on delete cascade not null,
  user_id uuid, -- Може посилатися на auth.users або user_settings
  cover_letter_no text, -- Текст норвезькою
  cover_letter_uk text, -- Переклад українською
  status text default 'draft', -- 'draft', 'approved', 'sent', 'rejected'
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  approved_at timestamp with time zone,
  sent_at timestamp with time zone,
  generated_prompt text,
  prompt_source text
);

-- 2. Вмикаємо захист (RLS)
alter table public.applications enable row level security;

-- 3. Додаємо політики доступу (для адмін-панелі дозволяємо все)
create policy "Enable read access for all users" on public.applications for select using (true);
create policy "Enable insert access for all users" on public.applications for insert with check (true);
create policy "Enable update access for all users" on public.applications for update using (true);
create policy "Enable delete access for all users" on public.applications for delete using (true);

-- 4. Оновлюємо таблицю Jobs, щоб додати статус APPLIED якщо його немає в enum
-- (Це не обов'язково, якщо ви використовуєте текстові поля, але корисно для цілісності)
comment on column public.jobs.status is 'Job status: NEW, ANALYZED, APPLIED, REJECTED';
